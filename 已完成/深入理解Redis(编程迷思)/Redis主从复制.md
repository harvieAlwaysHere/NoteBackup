# Redis主从复制

## 1.概述

### 概念

- 将Redis服务器的数据，从主节点单向复制到从节点

### 作用

- 数据热备份，数据冗余
- 故障恢复，服务冗余
- 负载均衡，读写分离
- 高可用基础，实现哨兵和集群的前提

## 2.配置

### 建立复制(从节点)

- 配置文件，slaveof <ip> <port>
- 启动命令，--slaveof <ip> <port>
- 客户端命令，slaveof <ip> <port>

### 断开复制(从节点)

- 客户端命令，slaveof no one

## 3.过程

### 连接建立

- 保存主节点信息(ip/port)，slaveof命令
- 建立Socket连接
- 从节点发送Ping命令，检查Socket连接是否可用
- 身份验证，从节点与主节点的masterauth一致
- 从节点发送端口信息，主节点保存至slave_listening_port字段

### 数据同步(初始化)

- 从节点向主节点发送psync命令
- 全量/部分复制
- 主从节点互为客户端

### 命令传播

- 主节点将写命令发送给从节点
- 从节点接收并执行命令，保持数据一致
- 主从节点维持心跳(PING/REPLCONF ACK)

## 4.全量/部分复制

### 全量复制

- 从节点/主节点判断无法部分复制，开始全量复制
- 主节点

	- 执行bgsave，生成RDB文件
	- 同时将所有写命令写入复制缓冲区
	- 发送RDB文件给从节点
	- 发送复制缓冲区的写命令给从节点

- 从节点

	- 清除旧数据
	- 载入主节点的RDB文件
	- 执行主节点的复制缓冲区的写命令
	- 若开启AOF，执行bgrewriteaof命令，更新AOF文件

- 缺点

	- 主节点执行bgsave命令fork子进程消耗大
	- 传输RDB文件，主从节点带宽消耗大
	- 从节点清除数据、载入RDB会阻塞
	- 从节点执行bgrewriteaof带来额外消耗

### 部分复制

- 处理网络中断时的数据同步
- 依赖的三大概念

	- 复制偏移量(offset)

		- 主节点向从节点传递的字节数
		- 主从节点分别维护
		- 用于判断主从节点数据库状态是否一致

	- 复制挤压缓冲区

		- 备份主节点最近发送给从节点的数据
		- 主节点维护、固定长度(1M)、先进先出
		- 用于和offset共同判断能否执行部分复制

	- 服务器运行标识(runid)

		- 每个Redis节点启动生成的随机标识
		- 主节点用于判断能否执行部分复制

### psync命令判断全量/部分复制

- 从节点初次复制

	- 从节点请求全量复制

- 从节点非初次复制

	- 从节点发送psync <runid> <offset>给主节点

		- 主节点版本低于Redis 2.8

			- 返回-ERR，执行全量复制

		- 主节点版本高于Redis 2.8

			- runid与主节点runid相同，且offset之后的数据在主节点复制挤压缓冲区中

				- 返回+CONTINUE，执行部分复制

			- runid与主节点runid不同，或offset之后的数据不在主节点复制及压缓冲区中

				- 返回+FULLRESYNC <runid> <offset>，执行全量复制

## 5.心跳机制

### 命令传播阶段，主从维持心跳机制

### 主->从，PING命令

- 频率由repl-ping-slave-period(10s)参数控制
- 从节点用于超时判断

### 从->主，REPLCONF ACK {offset}命令

- 频率1s
- 作用

	- 主节点监控从节点网络状态(复制超时)
	- 主节点检测写命令丢失(offset)
	- 主节点判断不安全而拒绝执行写命令

		- 从节点数量过少(min-slaves-to-write)
		- 从节点延迟过大(min-slaves-max-lag)

## 6.应用问题

### 读写分离问题

- 主从节点数据延迟和不一致

	- 优化主从节点之间的网络环境
	- 监控主从节点延迟(offset)，延迟过大则废弃从节点
	- 从节点配置slave-serve-stale-data(no)，不一致则不响应客户端命令

- 数据过期

	- 主节点删除策略

		- 惰性删除，客户端访问数据时判断是否过期，过期则删除
		- 定期删除，定时任务删除过期数据

	- 从节点删除策略

		- 读取数据判断是否过期，过期则不返回给客户端

- 故障切换

	- 哨兵

### 复制超时问题

- 主从节点根据repl-timeout(60s)参数判定超时，超时则释放连接
- 主节点

	- 距离收到从节点REPLCONF ACK命令的时间 

- 从节点

	- 连接建立阶段

		- 距离收到主节点信息的时间 

	- 数据同步阶段

		- 距离收到主节点RDB文件的时间

	- 命令传播阶段

		- 距离收到主节点PING命令或数据的时间

- 实际原因

	- 主节点fork+bgsave耗时过多
	- 主节点PING命令频率过长
	- 主从节点慢查询导致服务阻塞

### 复制中断问题

- 全量复制过慢，期间存储写命令溢出复制缓冲器

	- bgsave过慢，RDB太大
	- 主从节点网络延迟打，RDB传输慢
	- 从节点清空数据慢，载入RDB慢

- 可配置增大复制缓冲区

	- client-output-buffer-limit slave 256MB 64MB 60
	- 复制缓冲区大于256MB或连续60s大于64MB，则溢出中断连接

### 各场景的复制优化

- 第一次建立复制

	- 全量复制数据大，避开流量高峰期，避免阻塞
	- 多从节点，错峰复制

- 主节点重启

	- 宕机重启

		- 故障转移，升级从节点，避免因主节点runid变化导致全量复制

	- 安全重启

		- debug reload，调整启动参数或减少内存碎片，runid不变化，可部分复制

- 从节点重启

	- 保存的主节点runid丢失，全量复制

- 网络中断

	- 未触发超时

		- REPLCONF ACK {offset}，补充丢失的写命令

	- 触发超时

		- 复制挤压缓冲区包含丢失数据

			- 部分复制

		- 复制挤压缓冲区不包含丢失数据

			- 全量复制

## 7.相关配置与命令

### 主从节点

- repl-timeout 60

	- 超时判断时间

### 主节点

- repl-diskless-sync no

	- 全量复制，是否开启无盘复制，主节点直接将数据写入从节点的Socket中

- client-output-buffer-limit slave 256MB 64MB 60

	- 全量复制，主节点复制缓冲区大小

- repl-disable-tcp-nodelay no

	- 命令传播，主节点是否对TCP合并发送，会降低数据一致性

- masterauth <master-password>

	- 连接建立，身份验证

- repl-ping-slave-period 10

	- 命令传播，心跳机制，主节点PING频率

- repl-backlog-size 1mb

	- 命令传播/部分复制，复制挤压缓冲区大小

- repl-backlog-ttl 3600

	- 主节点没有从节点时，复制积压缓冲区保留时间

- min-slaves-to-write 3

	- 主节点最小从节点数目，少于则拒绝执行写命令

- min-slaves-max-lag 10

	- 主节点所有从节点最大延迟，大于则拒绝执行写命令

### 从节点

- slaveof <masterip> <masterport>

	- 从节点配置

- slave-serve-stale-data yes

	- 从节点数据不一致则不响应客户端命令

- slave-read-only yes

	- 从节点是否只读

### info Replication

- 查看节点与复制相关的状态

*XMind - Trial Version*